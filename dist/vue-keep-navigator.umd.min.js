!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).VueKeepNavigator=n()}(this,function(){"use strict";function l(e,n){if(!e.length||!n)return-1;for(var t=e.length-1;0<=t;t--)if(n(e[t],t))return t;return-1}function r(e,n,t){Object.defineProperty(e,n,t)}var a="NAVIGATION_RECORD",e="stack",d={key:"_sk",mode:e,keepAlive:!0,localCache:!1,disableFirstActivated:!0};r(d,e,{get:function(){return this.mode==e||"cache"!=this.mode}});var t=sessionStorage,i=function(e,n){t.setItem(e,JSON.stringify(n))},n=function(e){var n=t.getItem(e);try{n=JSON.parse(n)}catch(e){}return n};function o(){this.key="",this.caches=[],this.isForward=!1,this.isReplace=!1}!function(e){for(var n in e)r(o.prototype,n,e[n])}({index:{get:function(){var n=this;return l(n.caches,function(e){return e.key==n.key})}},size:{get:function(){return this.caches.length}},forward:{value:function(e,n){var t=this,o={key:t.key,tag:e};r(o,"vnode",{value:n,writable:!0}),t.index<0?t.isReplace&&t.remove(t.size-1,1):t.remove(t.index,1),t.caches.push(o),t.isReplace=!1,d.localCache&&i(a,t.caches)}},back:{value:function(e){var n=this,t=n.caches[n.index];!t.vnode&&e&&r(t,"vnode",{value:e,writable:!0}),n.remove(n.index+1,n.size),d.localCache&&i(a,n.caches)}},remove:{value:function(e,n){var o=this;if(-1<e)for(var r=o.caches.splice(e,n),t=function(e){var n=r[e],t=l(o.caches,function(e){return e.tag==n.tag&&e.vnode});n.vnode&&(d.stack||t<0)&&(n.vnode.componentInstance&&n.vnode.componentInstance.$destroy(),n.vnode=null)},a=0,i=r.length-1;a<=i;a++)t(a)}}});var h=new o,c=[],s={name:"keep-navigator",abstract:!0,props:{max:[Number,String]},methods:{push:function(e){var n=parseInt(this.max);if(n){if(d.stack)c.push("".concat(h.key,"::").concat(e));else{var t=c.indexOf(e);0<=t&&c.splice(t,1),c.push(e)}var o,r,a;c.length>n&&(r=(o=c)[0],a=d.stack,h.caches.filter(function(e){return a?"".concat(e.key,"::").concat(e.tag)==r&&e.vnode:e.tag==r&&e.vnode}).forEach(function(e){e.vnode&&(e.vnode.componentInstance&&e.vnode.componentInstance.$destroy(),e.vnode=null)}),function(e,n){if(e.length){var t=e.indexOf(n);if(-1<t)e.splice(t,1)}}(o,r))}},destroy:function(){h.remove(0,h.size)}},render:function(){var e,n,t,o=this,r=(e=o.$slots.default)&&e[0];if(r&&r.componentOptions){var a=h.caches,i=(n=o.$route,t=n.matched,n.name||t[t.length-1].path),c=o.$route.meta.keepAlive;if(null==c&&(c=d.keepAlive),h.isForward){if(!d.stack){if(!c)return h.forward(i,null),r;var s=l(a,function(e){return e.tag==i}),u=a[s];0<=s&&u.vnode&&u.vnode.componentInstance&&(r.componentInstance=u.vnode.componentInstance)}h.forward(i,r),o.push(i)}else{if(!d.stack&&!c)return h.back(null),r;var f=l(a,function(e){return e.key==h.key}),v=a[f];0<=f&&v.vnode&&v.vnode.componentInstance&&(r.componentInstance=v.vnode.componentInstance),h.back(r)}d.disableFirstActivated&&function(e){var n=e.componentOptions.Ctor.options;if(null!=n.isFirstEnter)return;n.isFirstEnter=!0,n.activated&&(n.activated=n.activated.map(function(e){return function(){this.$options.isFirstEnter?this.$options.isFirstEnter=!1:e.call(this)}}))}(r),r.data.keepAlive=!0}return r}};var u=n(a)||[];function f(e,n){return!!e.query[n]}return{install:function(e,n){var a=n&&n.router;if(!a)throw Error("[VueKeepNavigator]: router is necessary.");!function(e,n){for(var t in e)void 0!==n[t]&&(e[t]=n[t])}(d,n),e.component(s.name,s),d.localCache&&(h.caches=u);var t=a.replace;a.replace=function(){h.isReplace=!0,t.apply(a,arguments)};var i=new RegExp("[?&]".concat(d.key,"=[^&]+"));a.beforeHooks.unshift(function(e,n,t){var o=e.fullPath,r=n.fullPath;o!=r.replace(i,"")||"/"==r?f(e,d.key)?(h.key=e.query[d.key],a.isForward=h.isForward=-1==h.index||h.index==h.size-1,t()):(e.query[d.key]=Math.random().toString(16).substr(2,8),t({path:e.path,hash:e.hash,query:e.query,replace:h.isReplace||!f(n,d.key)})):t(!1)})}}});
